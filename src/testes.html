<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
  <h2>Upload de Imagem para Estabelecimento</h2>

  <label for="estabId">ID do Estabelecimento:</label>
  <input type="number" id="estabId" value="11"><br><br>

  <label for="imagemInput">Selecione a imagem:</label>
  <input type="file" id="imagemInput"><br><br>

  <button onclick="obterTokenEEnviar()">Enviar Imagem</button>

  <script>
    const clientId = "site_vegas_vantagens";
    const clientSecret = "8iYQ340vgwr4R1rOsdTg341m1/QEyGfLOIMkGQUasu0=";

    async function obterToken() {
      const resposta = await fetch("https://apivegasvantagens-production.up.railway.app/api/Auth/client-token", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ clientId, clientSecret })
      });

      if (!resposta.ok) {
        throw new Error("Erro ao obter token");
      }

      const dados = await resposta.json();
      return dados.accessToken;
    }

    async function enviarImagem(estabId, imagemFile, token) {
      const formData = new FormData();
      formData.append("imagem", imagemFile);
      formData.append("principal", "true");

      const resp = await fetch(`https://apivegasvantagens-production.up.railway.app/api/estabelecimentos/${estabId}/imagens`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
          // N√ÉO adicione Content-Type! O browser cuida disso com FormData.
        },
        body: formData
      });

      if (!resp.ok) {
        const erro = await resp.text();
        throw new Error("Erro ao enviar imagem: " + erro);
      }

      const resultado = await resp.json();
      alert("Imagem enviada com sucesso!");
      console.log("Resposta:", resultado);
    }

    async function obterTokenEEnviar() {
      const estabId = document.getElementById("estabId").value;
      const imagemFile = document.getElementById("imagemInput").files[0];

      if (!imagemFile || !estabId) {
        alert("Preencha todos os campos.");
        return;
      }

      try {
        const token = await obterToken();
        await enviarImagem(estabId, imagemFile, token);
      } catch (erro) {
        alert(erro.message);
        console.error(erro);
      }
    }
  </script>
</body>
</html>